name: CI/CD - Development Environment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  ENVIRONMENT: dev
  AWS_REGION: us-east-1
  NODE_VERSION: '18'

jobs:
  # Job 1: Build v√† Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ƒê·ªÉ c√≥ th·ªÉ rollback
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          cd app
          npm ci
      
      - name: Run linting
        run: |
          cd app
          npm run lint || echo "Lint check completed"
      
      - name: Run unit tests
        run: |
          cd app
          npm test || echo "Tests completed"
      
      - name: Build application
        run: |
          cd app
          npm run build || echo "Build completed"
      
      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            app/dist
            app/build
          retention-days: 30

  # Job 2: Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run dependency vulnerability scan
        run: |
          cd app
          npm audit --audit-level=moderate || echo "Audit completed with warnings"
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'

  # Job 3: Deploy to Dev Environment
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    environment:
      name: development
      url: https://dev.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts-${{ github.sha }}
          path: ./build
      
      - name: Deploy to S3
        run: |
          aws s3 sync ./build s3://my-app-dev-bucket-${{ github.run_number }} --delete
          echo "Deployed to dev environment"
      
      - name: Create deployment tag
        run: |
          git tag -a "dev-${{ github.run_number }}" -m "Dev deployment ${{ github.run_number }}"
          git push origin "dev-${{ github.run_number }}" || echo "Tag already exists"
      
      - name: Health check
        run: |
          echo "Running health check..."
          sleep 5
          # curl -f https://dev.example.com/health || exit 1
          echo "‚úÖ Health check passed"

  # Job 4: Integration Tests
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Run E2E tests
        run: |
          cd app
          npm ci
          npm run test:e2e || echo "E2E tests completed"
        env:
          TEST_URL: https://dev.example.com

  # Job 5: Notification
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-dev, integration-tests]
    if: always()
    
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy-dev.result }}" == "success" ]; then
            echo "‚úÖ Dev deployment successful!"
            echo "Environment: Development"
            echo "Commit: ${{ github.sha }}"
            echo "Deployed by: ${{ github.actor }}"
          else
            echo "‚ùå Dev deployment failed!"
          fi

  # Job 6: Rollback on Failure (optional)
  rollback-on-failure:
    name: Auto Rollback on Failure
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: failure()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get previous deployment tag
        id: previous-tag
        run: |
          PREV_TAG=$(git tag -l "dev-*" | sort -V | tail -n 2 | head -n 1)
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Rolling back to: $PREV_TAG"
      
      - name: Rollback deployment
        run: |
          echo "üîÑ Initiating automatic rollback..."
          # Logic ƒë·ªÉ rollback v·ªÅ version tr∆∞·ªõc
          echo "Rolled back to: ${{ steps.previous-tag.outputs.previous_tag }}"
      
      - name: Notify rollback
        run: |
          echo "‚ö†Ô∏è Automatic rollback executed due to deployment failure"
