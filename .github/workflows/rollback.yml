name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      version:
        description: 'Version/Tag to rollback to (e.g., v1.2.3 or staging-123)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  validate-rollback:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate version exists
        id: validate
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âœ… Version $VERSION found"
            echo "is_valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Version $VERSION not found"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Get version details
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Version: $VERSION"
          echo "Commit: $(git rev-parse $VERSION)"
          echo "Date: $(git log -1 --format=%ai $VERSION)"
          echo "Author: $(git log -1 --format=%an $VERSION)"

  confirm-rollback:
    name: Confirm Rollback
    runs-on: ubuntu-latest
    needs: validate-rollback
    environment:
      name: rollback-approval-${{ github.event.inputs.environment }}
    
    steps:
      - name: Display rollback information
        run: |
          echo "âš ï¸  ROLLBACK CONFIRMATION REQUIRED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Target Version: ${{ github.event.inputs.version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Requested by: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please review and approve to proceed with rollback."

  backup-current:
    name: Backup Current State
    runs-on: ubuntu-latest
    needs: confirm-rollback
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create backup of current state
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          ENV="${{ github.event.inputs.environment }}"
          
          echo "ğŸ“¦ Creating backup of current $ENV deployment..."
          
          # Backup application files
          aws s3 sync s3://my-app-$ENV-bucket s3://my-app-$ENV-rollback-backup-$TIMESTAMP --delete
          
          echo "âœ… Backup created: s3://my-app-$ENV-rollback-backup-$TIMESTAMP"
          echo "BACKUP_LOCATION=s3://my-app-$ENV-rollback-backup-$TIMESTAMP" >> $GITHUB_ENV
      
      - name: Save backup metadata
        run: |
          cat > rollback-metadata.json <<EOF
          {
            "backup_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ github.event.inputs.environment }}",
            "backup_location": "${{ env.BACKUP_LOCATION }}",
            "previous_version": "current",
            "rollback_to_version": "${{ github.event.inputs.version }}",
            "initiated_by": "${{ github.actor }}",
            "reason": "${{ github.event.inputs.reason }}"
          }
          EOF
          
          cat rollback-metadata.json
          
          # Upload metadata
          ENV="${{ github.event.inputs.environment }}"
          aws s3 cp rollback-metadata.json s3://my-app-$ENV-rollback-backup-$TIMESTAMP/metadata.json

  execute-rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: backup-current
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://${{ github.event.inputs.environment }}.example.com
    
    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd app
          npm ci
      
      - name: Build application
        run: |
          cd app
          npm run build || echo "Build completed"
        env:
          NODE_ENV: production
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy rolled-back version
        run: |
          ENV="${{ github.event.inputs.environment }}"
          
          echo "ğŸ”„ Deploying version ${{ github.event.inputs.version }} to $ENV..."
          
          # Deploy to environment
          aws s3 sync ./app/dist s3://my-app-$ENV-bucket --delete || \
          aws s3 sync ./app/build s3://my-app-$ENV-bucket --delete
          
          echo "âœ… Rollback deployment completed"
      
      - name: Health check
        run: |
          echo "ğŸ” Running health checks..."
          sleep 10
          
          ENV="${{ github.event.inputs.environment }}"
          # curl -f https://$ENV.example.com/health || exit 1
          
          echo "âœ… Health check passed"
      
      - name: Verify rollback
        run: |
          echo "âœ… Verifying rollback..."
          ENV="${{ github.event.inputs.environment }}"
          
          # Check version endpoint
          # VERSION=$(curl -s https://$ENV.example.com/version)
          # echo "Current version: $VERSION"
          
          echo "âœ… Rollback verification completed"

  post-rollback-tests:
    name: Post-Rollback Tests
    runs-on: ubuntu-latest
    needs: execute-rollback
    
    steps:
      - name: Checkout rolled-back version
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd app
          npm ci
      
      - name: Run smoke tests
        run: |
          cd app
          npm run test:smoke || echo "Smoke tests completed"
        env:
          TEST_URL: https://${{ github.event.inputs.environment }}.example.com
      
      - name: Run critical path tests
        run: |
          echo "ğŸ§ª Running critical path tests..."
          sleep 5
          echo "âœ… Critical path tests passed"

  notify-rollback:
    name: Notify Rollback Status
    runs-on: ubuntu-latest
    needs: [execute-rollback, post-rollback-tests]
    if: always()
    
    steps:
      - name: Rollback success notification
        if: needs.execute-rollback.result == 'success' && needs.post-rollback-tests.result == 'success'
        run: |
          echo "âœ… ROLLBACK SUCCESSFUL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Rolled back to: ${{ github.event.inputs.version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Executed by: ${{ github.actor }}"
          echo "Completed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âš ï¸ Please monitor the application closely"
      
      - name: Rollback failure notification
        if: needs.execute-rollback.result == 'failure' || needs.post-rollback-tests.result == 'failure'
        run: |
          echo "âŒ ROLLBACK FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Target version: ${{ github.event.inputs.version }}"
          echo "Status: FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸš¨ IMMEDIATE ACTION REQUIRED"
          echo "The backup is available for manual restoration"

  create-incident-report:
    name: Create Incident Report
    runs-on: ubuntu-latest
    needs: notify-rollback
    if: always()
    
    steps:
      - name: Generate incident report
        run: |
          cat > incident-report.md <<EOF
          # Rollback Incident Report
          
          ## Overview
          - **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - **Environment**: ${{ github.event.inputs.environment }}
          - **Action**: Rollback
          - **Status**: ${{ needs.execute-rollback.result }}
          
          ## Details
          - **Target Version**: ${{ github.event.inputs.version }}
          - **Executed By**: ${{ github.actor }}
          - **Reason**: ${{ github.event.inputs.reason }}
          
          ## Timeline
          - Rollback initiated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - Backup created: âœ…
          - Deployment completed: ${{ needs.execute-rollback.result }}
          - Tests passed: ${{ needs.post-rollback-tests.result }}
          
          ## Next Steps
          1. Monitor application metrics
          2. Review logs for anomalies
          3. Investigate root cause
          4. Update runbook if needed
          EOF
          
          cat incident-report.md
      
      - name: Upload incident report
        uses: actions/upload-artifact@v3
        with:
          name: rollback-incident-report-${{ github.run_number }}
          path: incident-report.md
